openapi: 3.1.2
info:
  title: GQTW Core API
  version: 1.0.0-draft
  summary: OpenAPI normative surface for GQTW wallet interoperability contracts.
  description: |
    This OpenAPI file is the normative endpoint contract for the GQTW profile.

    Semantics:
    - All request and response payloads are JSON objects.
    - Presentation and ingest-style operations are asynchronous unless a response explicitly states otherwise.
    - GQTS host retrieval operations are defined in GQTS Core and are referenced by operation id in GQTW prose.

    Versioning strategy:
    - Breaking wire changes require a new API version and migration text.
    - Profile-specific constraints are expressed through requirement ids and media types.
  license:
    name: MIT
    url: https://opensource.org/license/mit
  x-document-authority:
    status: unofficial-draft
    note: Not an adopted ETSI deliverable and not a W3C Recommendation.

servers:
  - url: https://example.org
    description: Example origin

security: []

x-gqtw-requirements:
  REQ-GQTW-07: Wallet-RP request/present/consent protocol with explicit challenge and audience binding.
  REQ-GQTW-08: Wallet-GQTS integration for head hints and signed incident reporting.
  REQ-GQTW-09: Wallet-GQSCD invocation binding to user-approved object digest.
  REQ-GQTW-10: Opaque encrypted portability export/import preserving user control.
  REQ-GQTW-11: Data-minimized erasure-request interface for wallet-RP interactions.
  REQ-GQTW-13: Profile discovery and profile evidence publication.

tags:
  - name: profile
    description: Wallet profile metadata and capability publication.
  - name: presentation
    description: Wallet-RP presentation request and submission flows.
  - name: gqts
    description: Wallet-side integration hooks for GQTS-derived head-state changes.
  - name: gqscd
    description: Wallet-GQSCD invocation hooks for signing, sealing, and attestation.
  - name: portability
    description: Opaque encrypted export and import workflows.
  - name: privacy
    description: Erasure and privacy-control interfaces.
  - name: incident
    description: Signed incident reporting for conflict or abuse evidence.

paths:
  /.well-known/gidas/gqtw/profile/{profileId}:
    get:
      tags: [profile]
      operationId: getWalletProfile
      summary: Get wallet profile metadata.
      x-gqtw-requirement: REQ-GQTW-13
      description: |
        Returns machine-readable metadata for one GQTW profile, including supported proof profiles,
        supported upstream host-profile operations, and conformance dependencies.
      parameters:
        - $ref: '#/components/parameters/ProfileId'
      responses:
        '200':
          description: Wallet profile metadata.
          content:
            application/gqtw.profile+json:
              schema:
                $ref: '#/components/schemas/WalletProfile'
            application/json:
              schema:
                $ref: '#/components/schemas/WalletProfile'
        '404':
          $ref: '#/components/responses/Problem'

  /.well-known/gidas/gqtw/presentation/request:
    post:
      tags: [presentation]
      operationId: postPresentationRequest
      summary: Submit a relying-party presentation request to a wallet endpoint.
      x-gqtw-requirement: REQ-GQTW-07
      description: |
        Accepts a relying-party request that asks for one or more selectively disclosed claims.
        Wallet implementations MUST bind all accepted requests to explicit challenge and audience values.
      requestBody:
        required: true
        content:
          application/gqtw.presentation-request+json:
            schema:
              $ref: '#/components/schemas/PresentationRequest'
          application/json:
            schema:
              $ref: '#/components/schemas/PresentationRequest'
      responses:
        '202':
          description: Request accepted for wallet-user consent workflow.
          content:
            application/gqtw.presentation-request-receipt+json:
              schema:
                $ref: '#/components/schemas/PresentationRequestReceipt'
            application/json:
              schema:
                $ref: '#/components/schemas/PresentationRequestReceipt'
        '400':
          $ref: '#/components/responses/Problem'
        '409':
          $ref: '#/components/responses/Problem'

  /.well-known/gidas/gqtw/presentation/{requestId}/submit:
    post:
      tags: [presentation]
      operationId: postPresentationSubmission
      summary: Submit a wallet presentation for a previously accepted request.
      x-gqtw-requirement: REQ-GQTW-07
      description: |
        Submits the holder-approved presentation output for one presentation request.
        The submission payload can contain VC/VP-family artifacts and profile-defined selective disclosure proofs.
      parameters:
        - $ref: '#/components/parameters/RequestId'
      requestBody:
        required: true
        content:
          application/gqtw.presentation-submission+json:
            schema:
              $ref: '#/components/schemas/PresentationSubmission'
          application/json:
            schema:
              $ref: '#/components/schemas/PresentationSubmission'
      responses:
        '200':
          description: Submission accepted and mechanically verified.
          content:
            application/gqtw.presentation-verification+json:
              schema:
                $ref: '#/components/schemas/PresentationVerificationResult'
            application/json:
              schema:
                $ref: '#/components/schemas/PresentationVerificationResult'
        '400':
          $ref: '#/components/responses/Problem'
        '404':
          $ref: '#/components/responses/Problem'
        '422':
          $ref: '#/components/responses/Problem'

  /.well-known/gidas/gqtw/gqts/head-hint:
    post:
      tags: [gqts]
      operationId: postGqtsHeadHint
      summary: Submit a compact head-state hint derived from a GQTS history view.
      x-gqtw-requirement: REQ-GQTW-08
      description: |
        Accepts a compact head-state hint so wallet implementations can decide if heavier retrieval is needed.
        This operation does not replace authoritative retrieval from GQTS endpoints.
      requestBody:
        required: true
        content:
          application/gqtw.gqts-head-hint+json:
            schema:
              $ref: '#/components/schemas/GqtsHeadHint'
          application/json:
            schema:
              $ref: '#/components/schemas/GqtsHeadHint'
      responses:
        '202':
          description: Hint accepted.
          content:
            application/gqtw.async-receipt+json:
              schema:
                $ref: '#/components/schemas/AsyncReceipt'
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncReceipt'
        '400':
          $ref: '#/components/responses/Problem'

  /.well-known/gidas/gqtw/gqscd/invocation:
    post:
      tags: [gqscd]
      operationId: postGqscdInvocation
      summary: Invoke a GQSCD-backed signing, sealing, or attestation operation.
      x-gqtw-requirement: REQ-GQTW-09
      description: |
        Invokes a protected-key operation through a GQSCD-conformant interface.
        User intent and user-approved object digest binding are required inputs.
      requestBody:
        required: true
        content:
          application/gqtw.gqscd-invocation+json:
            schema:
              $ref: '#/components/schemas/GqscdInvocationRequest'
          application/json:
            schema:
              $ref: '#/components/schemas/GqscdInvocationRequest'
      responses:
        '200':
          description: Invocation result.
          content:
            application/gqtw.gqscd-invocation-result+json:
              schema:
                $ref: '#/components/schemas/GqscdInvocationResult'
            application/json:
              schema:
                $ref: '#/components/schemas/GqscdInvocationResult'
        '400':
          $ref: '#/components/responses/Problem'
        '403':
          $ref: '#/components/responses/Problem'

  /.well-known/gidas/gqtw/portability/export:
    post:
      tags: [portability]
      operationId: postWalletExport
      summary: Create an opaque encrypted portability package.
      x-gqtw-requirement: REQ-GQTW-10
      description: |
        Exports wallet-private material as an encrypted opaque package.
        The package is designed for controlled migration and backup, not public publication.
      requestBody:
        required: true
        content:
          application/gqtw.portability-export-request+json:
            schema:
              $ref: '#/components/schemas/WalletExportRequest'
          application/json:
            schema:
              $ref: '#/components/schemas/WalletExportRequest'
      responses:
        '200':
          description: Opaque portability package.
          content:
            application/gqtw.portability-package+json:
              schema:
                $ref: '#/components/schemas/WalletExportPackage'
            application/json:
              schema:
                $ref: '#/components/schemas/WalletExportPackage'
        '400':
          $ref: '#/components/responses/Problem'

  /.well-known/gidas/gqtw/portability/import:
    post:
      tags: [portability]
      operationId: postWalletImport
      summary: Import an opaque encrypted portability package.
      x-gqtw-requirement: REQ-GQTW-10
      description: |
        Imports an opaque encrypted package and performs integrity checks before activation.
      requestBody:
        required: true
        content:
          application/gqtw.portability-import-request+json:
            schema:
              $ref: '#/components/schemas/WalletImportRequest'
          application/json:
            schema:
              $ref: '#/components/schemas/WalletImportRequest'
      responses:
        '200':
          description: Import result.
          content:
            application/gqtw.portability-import-result+json:
              schema:
                $ref: '#/components/schemas/WalletImportResult'
            application/json:
              schema:
                $ref: '#/components/schemas/WalletImportResult'
        '400':
          $ref: '#/components/responses/Problem'
        '409':
          $ref: '#/components/responses/Problem'

  /.well-known/gidas/gqtw/privacy/erasure:
    post:
      tags: [privacy]
      operationId: postErasureRequest
      summary: Submit a holder-scoped data-erasure request.
      x-gqtw-requirement: REQ-GQTW-11
      description: |
        Submits an erasure request for data previously disclosed through wallet-mediated presentation flows.
      requestBody:
        required: true
        content:
          application/gqtw.erasure-request+json:
            schema:
              $ref: '#/components/schemas/ErasureRequest'
          application/json:
            schema:
              $ref: '#/components/schemas/ErasureRequest'
      responses:
        '202':
          description: Erasure request accepted.
          content:
            application/gqtw.erasure-receipt+json:
              schema:
                $ref: '#/components/schemas/ErasureReceipt'
            application/json:
              schema:
                $ref: '#/components/schemas/ErasureReceipt'
        '400':
          $ref: '#/components/responses/Problem'

  /.well-known/gidas/gqtw/incident/report:
    post:
      tags: [incident]
      operationId: postWalletIncidentReport
      summary: Submit a signed incident report.
      x-gqtw-requirement: REQ-GQTW-08
      description: |
        Submits signed evidence about host conflicts, replay attempts, policy abuse, or profile violations.
      requestBody:
        required: true
        content:
          application/gqtw.incident-report+json:
            schema:
              $ref: '#/components/schemas/IncidentReport'
          application/json:
            schema:
              $ref: '#/components/schemas/IncidentReport'
      responses:
        '202':
          description: Incident report accepted for asynchronous processing.
          content:
            application/gqtw.async-receipt+json:
              schema:
                $ref: '#/components/schemas/AsyncReceipt'
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncReceipt'
        '400':
          $ref: '#/components/responses/Problem'

components:
  parameters:
    ProfileId:
      name: profileId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/Identifier'
    RequestId:
      name: requestId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/Identifier'

  responses:
    Problem:
      description: Error response.
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'

  schemas:
    Identifier:
      type: string
      minLength: 1
      maxLength: 128
      pattern: '^[A-Za-z0-9._:-]+$'

    DidUri:
      type: string
      minLength: 8
      pattern: '^did:[a-z0-9]+:.+$'

    Uri:
      type: string
      format: uri

    IsoDateTime:
      type: string
      format: date-time

    WalletProfile:
      type: object
      additionalProperties: false
      required:
        - profileId
        - profileVersion
        - proofProfiles
        - upstreamRequirements
        - gqtsOperations
      properties:
        profileId:
          $ref: '#/components/schemas/Identifier'
        profileVersion:
          type: string
          pattern: '^[0-9]+\.[0-9]+\.[0-9]+(-[A-Za-z0-9.-]+)?$'
        proofProfiles:
          type: array
          minItems: 1
          items:
            type: string
            enum:
              - bbs-profile
              - oprf-profile
              - sd-profile
              - profile-extension
        upstreamRequirements:
          type: array
          minItems: 1
          items:
            type: string
            pattern: '^REQ-(GQTS|GQSCD|GDIS|GQTW)-[0-9]{2}$'
        gqtsOperations:
          type: array
          minItems: 1
          items:
            type: string
            enum:
              - getSchemeDescriptor
              - getEndpointKindCatalog
              - getTypeDescriptor
              - getEventLogView
              - getEventHeadMeta
              - getEventById
        gqscdProfileRefs:
          type: array
          items:
            type: string

    PresentationRequest:
      type: object
      additionalProperties: false
      required:
        - requestId
        - challenge
        - audience
        - relyingParty
        - requestedClaims
        - expiresAt
      properties:
        requestId:
          $ref: '#/components/schemas/Identifier'
        challenge:
          type: string
          minLength: 16
        audience:
          type: string
          minLength: 1
        relyingParty:
          $ref: '#/components/schemas/RelyingPartyDescriptor'
        requestedClaims:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/ClaimRequest'
        selectiveDisclosureRequired:
          type: boolean
          default: true
        proofProfile:
          type: string
          enum:
            - bbs-profile
            - oprf-profile
            - sd-profile
            - profile-extension
        expiresAt:
          $ref: '#/components/schemas/IsoDateTime'

    PresentationRequestReceipt:
      type: object
      additionalProperties: false
      required:
        - requestId
        - status
      properties:
        requestId:
          $ref: '#/components/schemas/Identifier'
        status:
          type: string
          enum:
            - accepted
            - rejected
            - pending-user-consent
        consentHandle:
          $ref: '#/components/schemas/Identifier'
        expiresAt:
          $ref: '#/components/schemas/IsoDateTime'

    PresentationSubmission:
      type: object
      additionalProperties: false
      required:
        - requestId
        - holderDid
        - proofArtifact
        - consentReceipt
      properties:
        requestId:
          $ref: '#/components/schemas/Identifier'
        holderDid:
          $ref: '#/components/schemas/DidUri'
        proofArtifact:
          $ref: '#/components/schemas/ProofArtifactEnvelope'
        disclosedClaims:
          type: array
          items:
            $ref: '#/components/schemas/ClaimDisclosure'
        consentReceipt:
          $ref: '#/components/schemas/ConsentReceipt'

    PresentationVerificationResult:
      type: object
      additionalProperties: false
      required:
        - requestId
        - mechanicalValidity
        - checkedAt
      properties:
        requestId:
          $ref: '#/components/schemas/Identifier'
        mechanicalValidity:
          type: string
          enum: [valid, invalid, indeterminate]
        recognitionStatus:
          type: string
          enum: [out-of-scope, recognized, not-recognized, pending]
        checkedAt:
          $ref: '#/components/schemas/IsoDateTime'
        failureCodes:
          type: array
          items:
            type: string

    RelyingPartyDescriptor:
      type: object
      additionalProperties: false
      required:
        - relyingPartyId
      properties:
        relyingPartyId:
          $ref: '#/components/schemas/Identifier'
        registrationCertificate:
          type: string
        registrationJurisdiction:
          type: string

    ClaimRequest:
      type: object
      additionalProperties: false
      required:
        - claimId
        - purpose
      properties:
        claimId:
          type: string
        purpose:
          type: string
        required:
          type: boolean
          default: true

    ClaimDisclosure:
      type: object
      additionalProperties: false
      required:
        - claimId
        - valueDigest
      properties:
        claimId:
          type: string
        valueDigest:
          type: string
          pattern: '^[A-Za-z0-9_-]{16,}$'
        value:
          description: Optional disclosed cleartext value when policy allows.

    ConsentReceipt:
      type: object
      additionalProperties: false
      required:
        - consentHandle
        - approvedAt
        - userApprovedObjectDigest
      properties:
        consentHandle:
          $ref: '#/components/schemas/Identifier'
        approvedAt:
          $ref: '#/components/schemas/IsoDateTime'
        userApprovedObjectDigest:
          type: string
          pattern: '^[A-Za-z0-9_-]{16,}$'
        gqscdEvidenceRef:
          type: string

    ProofArtifactEnvelope:
      type: object
      description: VC/VP-family artifact envelope or profile-equivalent object.
      required:
        - format
        - artifact
        - proof
      additionalProperties: false
      properties:
        format:
          type: string
          enum:
            - vc
            - vp
            - profiled-equivalent
        artifact:
          type: object
          additionalProperties: true
        proof:
          type: object
          additionalProperties: true

    GqtsHeadHint:
      type: object
      additionalProperties: false
      required:
        - logId
        - hostOrigin
        - headToken
        - headDigest
        - observedAt
      properties:
        logId:
          $ref: '#/components/schemas/Identifier'
        hostOrigin:
          $ref: '#/components/schemas/Uri'
        headToken:
          $ref: '#/components/schemas/Identifier'
        headDigest:
          type: string
          pattern: '^[A-Za-z0-9_-]{16,}$'
        observedAt:
          $ref: '#/components/schemas/IsoDateTime'

    GqscdInvocationRequest:
      type: object
      additionalProperties: false
      required:
        - invocationId
        - operationType
        - keyReference
        - userApprovedObjectDigest
        - challenge
        - audience
      properties:
        invocationId:
          $ref: '#/components/schemas/Identifier'
        operationType:
          type: string
          enum: [sign, seal, attest]
        keyReference:
          type: string
        userApprovedObjectDigest:
          type: string
          pattern: '^[A-Za-z0-9_-]{16,}$'
        challenge:
          type: string
          minLength: 16
        audience:
          type: string
          minLength: 1

    GqscdInvocationResult:
      type: object
      additionalProperties: false
      required:
        - invocationId
        - status
      properties:
        invocationId:
          $ref: '#/components/schemas/Identifier'
        status:
          type: string
          enum: [succeeded, denied, failed]
        signatureObject:
          type: object
          additionalProperties: true
        evidenceReferences:
          type: array
          items:
            type: string

    WalletExportRequest:
      type: object
      additionalProperties: false
      required:
        - exportId
        - recipientPublicKey
      properties:
        exportId:
          $ref: '#/components/schemas/Identifier'
        recipientPublicKey:
          type: object
          additionalProperties: true
        includePrivateLog:
          type: boolean
          default: true
        includeArtifacts:
          type: boolean
          default: true

    WalletExportPackage:
      type: object
      additionalProperties: false
      required:
        - packageId
        - cipherSuite
        - ciphertext
        - digest
        - createdAt
      properties:
        packageId:
          $ref: '#/components/schemas/Identifier'
        cipherSuite:
          type: string
        ciphertext:
          type: string
        digest:
          type: string
        createdAt:
          $ref: '#/components/schemas/IsoDateTime'

    WalletImportRequest:
      type: object
      additionalProperties: false
      required:
        - package
      properties:
        package:
          $ref: '#/components/schemas/WalletExportPackage'
        decryptionContext:
          type: object
          additionalProperties: true

    WalletImportResult:
      type: object
      additionalProperties: false
      required:
        - status
      properties:
        status:
          type: string
          enum: [imported, rejected, partial]
        activatedHeadToken:
          $ref: '#/components/schemas/Identifier'
        migratedArtifactCount:
          type: integer
          minimum: 0

    ErasureRequest:
      type: object
      additionalProperties: false
      required:
        - requestId
        - relyingPartyId
        - submittedAt
      properties:
        requestId:
          $ref: '#/components/schemas/Identifier'
        relyingPartyId:
          $ref: '#/components/schemas/Identifier'
        legalBasis:
          type: string
          default: gdpr-article-17
        proofOfInteraction:
          type: string
        submittedAt:
          $ref: '#/components/schemas/IsoDateTime'

    ErasureReceipt:
      type: object
      additionalProperties: false
      required:
        - requestId
        - status
      properties:
        requestId:
          $ref: '#/components/schemas/Identifier'
        status:
          type: string
          enum: [accepted, rejected, completed]
        reference:
          type: string

    IncidentReport:
      type: object
      additionalProperties: false
      required:
        - reportId
        - incidentType
        - reportedAt
        - evidence
      properties:
        reportId:
          $ref: '#/components/schemas/Identifier'
        incidentType:
          type: string
          enum:
            - host-divergence
            - fork-detected
            - replay-attempt
            - policy-abuse
            - profile-violation
        affectedHost:
          $ref: '#/components/schemas/Uri'
        affectedLogId:
          $ref: '#/components/schemas/Identifier'
        reporterDid:
          $ref: '#/components/schemas/DidUri'
        reportedAt:
          $ref: '#/components/schemas/IsoDateTime'
        evidence:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/IncidentEvidenceItem'
        signature:
          type: object
          additionalProperties: true

    IncidentEvidenceItem:
      type: object
      additionalProperties: false
      required:
        - kind
        - digest
      properties:
        kind:
          type: string
          enum:
            - event-envelope
            - head-meta
            - receipt
            - policy-proof
            - audit-trace
        digest:
          type: string
        uri:
          $ref: '#/components/schemas/Uri'

    AsyncReceipt:
      type: object
      additionalProperties: false
      required:
        - receiptId
        - acceptedAt
        - status
      properties:
        receiptId:
          $ref: '#/components/schemas/Identifier'
        acceptedAt:
          $ref: '#/components/schemas/IsoDateTime'
        status:
          type: string
          enum: [accepted, rejected]

    ProblemDetails:
      type: object
      additionalProperties: true
      required:
        - type
        - title
        - status
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
          minimum: 100
          maximum: 599
        detail:
          type: string
        instance:
          type: string
          format: uri
        code:
          type: string
